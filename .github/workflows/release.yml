name: Release

on:
  release:
    types: [published]

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    strategy:
      matrix:
        include:
          - os: linux
            arch: amd64
            zip: gormeparser-linux-amd64.zip
          - os: linux
            arch: arm64
            zip: gormeparser-linux-arm64.zip
          - os: macos
            arch: amd64
            zip: gormeparser-macos-amd64.zip
          - os: macos
            arch: arm64
            zip: gormeparser-macos-arm64.zip
          - os: windows
            arch: amd64
            zip: gormeparser-windows-amd64.zip

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Build binary
        env:
          GOOS: ${{ matrix.os }}
          GOARCH: ${{ matrix.arch }}
        run: |
          EXT=""
          if [ "$GOOS" = "windows" ]; then
            EXT=".exe"
          fi

          NAME="gormeparser${EXT}"
          go build -ldflags="-s -w" -o "$NAME" ./cmd/gormeparser

          # Make executable
          if [ "$GOOS" != "windows" ]; then
            chmod +x "$NAME"
          fi

          # Create zip
          if [ "$GOOS" = "windows" ]; then
            powershell -Command "Compress-Archive -Path gormeparser.exe -DestinationPath ${{ matrix.zip }} -Force"
          else
            zip -j ${{ matrix.zip }} "$NAME"
          fi

      - name: Upload release asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: ./${{ matrix.zip }}
          asset_name: ${{ matrix.zip }}
          asset_content_type: application/zip

  release-notes:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate release notes
        id: release-notes
        run: |
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          CURRENT_TAG=${{ github.ref_name }}

          cat > release-notes.md << 'HEADER'
          ## What's Changed

          HEADER

          if [ -n "$PREV_TAG" ]; then
            git log --pretty=format:"- %s (%h)" $PREV_TAG..HEAD >> release-notes.md
          else
            git log --pretty=format:"- %s (%h)" -n 20 >> release-notes.md
          fi

          cat >> release-notes.md << 'FOOTER'

          ## Downloads

          Pre-built binaries (zip format):

          | Platform | Architecture | Download |
          |----------|--------------|----------|
          | Linux | amd64 | gormeparser-linux-amd64.zip |
          | Linux | arm64 | gormeparser-linux-arm64.zip |
          | macOS | amd64 | gormeparser-macos-amd64.zip |
          | macOS | arm64 (Apple Silicon) | gormeparser-macos-arm64.zip |
          | Windows | amd64 | gormeparser-windows-amd64.zip |

          ## Usage

          ```bash
          # Linux/macOS
          unzip gormeparser-linux-amd64.zip
          ./gormeparser --help

          # Windows
          unzip gormeparser-windows-amd64.zip
          gormeparser.exe --help
          ```

          Extract the zip and run the binary.
          FOOTER

          cat release-notes.md

      - name: Update release body
        run: |
          curl -s -X PATCH \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Content-Type: application/json" \
            https://api.github.com/repos/${{ github.repository }}/releases/${{ github.event.release.id }} \
            -d '{"body": $(cat release-notes.md | jq -Rs .)}'
